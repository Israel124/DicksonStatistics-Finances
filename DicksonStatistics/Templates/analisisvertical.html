{% extends 'base.html' %}

{% block title %}Análisis Vertical - DicksonStatistics{% endblock %}

{% block extra_css %}
<style>
  :root {
    --primary: #00d9ff;
    --secondary: #0099cc;
    --accent: #ff006e;
    --dark-bg: #0a0e27;
    --card-bg: #1a1f3a;
    --border-color: #2d3561;
    --text-primary: #e0e0e0;
    --text-secondary: #a0a0a0;
    --success: #00ff88;
    --warning: #ffaa00;
    --danger: #ff3366;
  }

  .section-header {
    background: linear-gradient(135deg, rgba(0, 217, 255, 0.1) 0%, rgba(255, 0, 110, 0.1) 100%);
    border: 1px solid var(--border-color);
    border-radius: 20px;
    padding: 40px;
    margin-bottom: 30px;
    position: relative;
    overflow: hidden;
  }

  .section-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 200%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(0, 217, 255, 0.1), transparent);
    animation: shimmer 3s infinite;
  }

  @keyframes shimmer {
    0% { left: -100%; }
    100% { left: 100%; }
  }

  .section-title {
    font-size: 2rem;
    font-weight: 800;
    background: linear-gradient(90deg, var(--primary), var(--accent));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 15px;
    position: relative;
    z-index: 1;
  }

  .section-subtitle {
    color: var(--text-secondary);
    font-size: 1.1rem;
    position: relative;
    z-index: 1;
  }

  .card {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 15px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    transition: all 0.3s ease;
    margin-bottom: 30px;
  }

  .card:hover {
    border-color: var(--primary);
    box-shadow: 0 12px 48px rgba(0, 217, 255, 0.2);
    transform: translateY(-5px);
  }

  .card-header {
    background: linear-gradient(90deg, rgba(0, 217, 255, 0.1), rgba(255, 0, 110, 0.1));
    border-bottom: 1px solid var(--border-color);
    border-radius: 15px 15px 0 0;
    padding: 20px;
    font-weight: 600;
    color: var(--primary);
  }

  .card-body {
    padding: 25px;
  }

  .btn-primary-glow {
    background: linear-gradient(90deg, var(--primary), var(--secondary));
    border: none;
    color: var(--dark-bg);
    font-weight: 600;
    border-radius: 10px;
    padding: 12px 24px;
    transition: all 0.3s ease;
    box-shadow: 0 0 20px rgba(0, 217, 255, 0.3);
  }

  .btn-primary-glow:hover {
    box-shadow: 0 0 40px rgba(0, 217, 255, 0.6);
    transform: translateY(-2px);
    color: var(--dark-bg);
  }

  .input-futurista {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid var(--border-color);
    color: var(--text-primary);
    border-radius: 10px;
    padding: 12px 15px;
    transition: all 0.3s ease;
  }

  .input-futurista:focus {
    background: rgba(255, 255, 255, 0.08);
    border-color: var(--primary);
    box-shadow: 0 0 20px rgba(0, 217, 255, 0.2);
    color: var(--text-primary);
  }

  .input-futurista::placeholder {
    color: var(--text-secondary);
  }

  .table {
    color: var(--text-primary);
    margin-bottom: 0;
  }

  .table thead {
    border-bottom: 2px solid var(--primary);
  }

  .table thead th {
    color: var(--primary);
    font-weight: 600;
    border: none;
    padding: 15px;
    text-transform: uppercase;
    font-size: 0.85rem;
    letter-spacing: 1px;
  }

  .table tbody td {
    border-color: var(--border-color);
    padding: 12px 15px;
    vertical-align: middle;
  }

  .table tbody tr {
    transition: all 0.3s ease;
  }

  .table tbody tr:hover {
    background: rgba(0, 217, 255, 0.05);
    border-color: var(--primary);
  }

  .badge-futurista {
    background: rgba(0, 217, 255, 0.2);
    color: var(--primary);
    border: 1px solid var(--primary);
    padding: 6px 12px;
    border-radius: 8px;
    font-weight: 600;
    font-size: 0.85rem;
  }

  .subseccion-titulo {
    color: var(--primary);
    font-weight: 700;
    font-size: 1.2rem;
    margin-top: 20px;
    margin-bottom: 15px;
    border-left: 4px solid var(--primary);
    padding-left: 15px;
  }

  .fila-total {
    background: rgba(0, 217, 255, 0.1);
    font-weight: 700;
    border-top: 2px solid var(--primary);
    border-bottom: 2px solid var(--primary);
  }

  .fila-subtotal {
    background: rgba(0, 217, 255, 0.05);
    font-weight: 600;
    border-top: 1px solid var(--border-color);
    border-bottom: 1px dashed var(--border-color);
  }

  .fila-operacion {
    background: rgba(255, 255, 255, 0.02);
    font-style: italic;
    color: var(--text-secondary);
  }

  .nav-tabs .nav-link {
    color: var(--text-secondary);
    border: none;
    border-bottom: 3px solid transparent;
    border-radius: 0;
    padding: 15px 20px;
    transition: all 0.3s ease;
  }

  .nav-tabs .nav-link:hover {
    color: var(--primary);
    border-bottom-color: var(--primary);
  }

  .nav-tabs .nav-link.active {
    color: var(--primary);
    border-bottom-color: var(--primary);
    background: transparent;
  }

  .metric-card {
    background: linear-gradient(135deg, rgba(0, 217, 255, 0.1), rgba(255, 0, 110, 0.05));
    border: 1px solid var(--border-color);
    border-radius: 15px;
    padding: 25px;
    margin-bottom: 20px;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }

  .metric-card:hover {
    border-color: var(--primary);
    box-shadow: 0 8px 32px rgba(0, 217, 255, 0.15);
  }

  .metric-value {
    font-size: 2rem;
    font-weight: 900;
    background: linear-gradient(90deg, var(--primary), var(--accent));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .metric-label {
    color: var(--text-secondary);
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-top: 8px;
  }

  .empty-state {
    text-align: center;
    padding: 40px 20px;
    color: var(--text-secondary);
  }

  .modal-content {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 15px;
  }

  .modal-header {
    border-bottom: 1px solid var(--border-color);
    background: linear-gradient(90deg, rgba(0, 217, 255, 0.1), rgba(255, 0, 110, 0.1));
  }

  .modal-header .btn-close {
    filter: invert(1);
  }

  .modal-title {
    color: var(--primary);
    font-weight: 700;
  }

  .modal-body {
    color: var(--text-primary);
  }

  .estado-resultados-tabla {
    width: 100%;
    border-collapse: collapse;
  }

  .estado-resultados-tabla td {
    padding: 10px 15px;
    border: none;
    color: var(--text-primary);
  }

  .estado-resultados-tabla .concepto {
    text-align: left;
    font-weight: 500;
  }

  .estado-resultados-tabla .monto {
    text-align: right;
    min-width: 150px;
  }

  .estado-resultados-tabla .monto-editable {
    background: rgba(0, 217, 255, 0.1);
    border: 1px solid var(--primary);
    border-radius: 5px;
    padding: 5px 10px;
    color: var(--text-primary);
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .estado-resultados-tabla .monto-editable:hover {
    background: rgba(0, 217, 255, 0.2);
    box-shadow: 0 0 10px rgba(0, 217, 255, 0.3);
  }

  .estado-resultados-tabla .operacion {
    color: var(--text-secondary);
    font-size: 0.9rem;
    font-style: italic;
  }

  .estado-resultados-tabla .titulo-seccion {
    background: rgba(0, 217, 255, 0.1);
    font-weight: 700;
    color: var(--primary);
    border-top: 2px solid var(--primary);
    border-bottom: 2px solid var(--primary);
  }

  .estado-resultados-tabla .subtotal {
    background: rgba(0, 217, 255, 0.05);
    font-weight: 600;
    border-bottom: 1px dashed var(--border-color);
  }

  .estado-resultados-tabla .total-final {
    background: rgba(0, 217, 255, 0.15);
    font-weight: 800;
    border-top: 2px solid var(--primary);
    border-bottom: 3px solid var(--primary);
  }

  .input-monto-modal {
    background: rgba(255, 255, 255, 0.05);
    border: 2px solid var(--primary);
    color: var(--text-primary);
    border-radius: 10px;
    padding: 12px 15px;
    font-size: 1.2rem;
    font-weight: 600;
    width: 100%;
    text-align: right;
  }

  .input-monto-modal:focus {
    background: rgba(255, 255, 255, 0.1);
    box-shadow: 0 0 20px rgba(0, 217, 255, 0.4);
    outline: none;
  }

  .analisis-tabla {
    width: 100%;
    border-collapse: collapse;
  }

  .analisis-tabla td {
    padding: 12px 15px;
    border: none;
    color: var(--text-primary);
  }

  .analisis-tabla .concepto {
    text-align: left;
    font-weight: 500;
  }

  .analisis-tabla .valor {
    text-align: right;
    min-width: 120px;
  }

  .analisis-tabla .porcentaje {
    text-align: right;
    min-width: 100px;
  }

  .analisis-tabla .titulo-seccion {
    background: rgba(0, 217, 255, 0.1);
    font-weight: 700;
    color: var(--primary);
    border-top: 2px solid var(--primary);
    border-bottom: 2px solid var(--primary);
  }

  .analisis-tabla .subtotal {
    background: rgba(0, 217, 255, 0.05);
    font-weight: 600;
    border-bottom: 1px dashed var(--border-color);
  }

  .analisis-tabla .total-final {
    background: rgba(0, 217, 255, 0.15);
    font-weight: 800;
    border-top: 2px solid var(--primary);
    border-bottom: 3px solid var(--primary);
  }

  .barra-porcentaje {
    background: rgba(0, 217, 255, 0.2);
    border: 1px solid var(--primary);
    border-radius: 5px;
    height: 20px;
    overflow: hidden;
    position: relative;
  }

  .barra-relleno {
    background: linear-gradient(90deg, var(--primary), var(--accent));
    height: 100%;
    border-radius: 5px;
    transition: width 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: flex-end;
    padding-right: 5px;
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--dark-bg);
  }

  @media (max-width: 768px) {
    .section-title {
      font-size: 1.5rem;
    }

    .metric-value {
      font-size: 1.5rem;
    }

    .section-header {
      padding: 25px;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid p-4" style="position: relative; z-index: 1;">
  <!-- Hero Section -->
  <section class="section-header">
    <div class="row align-items-center">
      <div class="col-lg-8">
        <h1 class="section-title"><i class="fas fa-chart-pie" style="margin-right: 15px; text-shadow: 0 0 20px rgba(0, 217, 255, 0.5);"></i>Análisis Vertical Financiero</h1>
        <p class="section-subtitle">Plataforma avanzada para análisis financiero con estructura contable completa</p>
      </div>
      <div class="col-lg-4 text-center">
        <div style="font-size: 4rem; color: var(--primary); text-shadow: 0 0 30px rgba(0, 217, 255, 0.5);">
          <i class="fas fa-percent"></i>
        </div>
      </div>
    </div>
  </section>

  <!-- Tabs para Análisis -->
  <section id="analisis" class="mb-5">
    <ul class="nav nav-tabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="tab-er" data-bs-toggle="tab" data-bs-target="#contenido-er" type="button">
          <i class="fas fa-file-invoice-dollar"></i> Estado de Resultados
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="tab-bg" data-bs-toggle="tab" data-bs-target="#contenido-bg" type="button">
          <i class="fas fa-building"></i> Balance General
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="tab-analisis" data-bs-toggle="tab" data-bs-target="#contenido-analisis" type="button">
          <i class="fas fa-chart-bar"></i> Análisis Vertical
        </button>
      </li>
    </ul>

    <div class="tab-content">
      <!-- ESTADO DE RESULTADOS -->
      <div class="tab-pane fade show active" id="contenido-er" role="tabpanel">
        <h2 style="font-size: 1.8rem; font-weight: 800; color: var(--primary); margin-top: 30px; margin-bottom: 30px; border-bottom: 2px solid var(--primary); padding-bottom: 15px;">
          <i class="fas fa-file-invoice-dollar"></i> Estructura del Estado de Resultados
        </h2>

        <div class="alert alert-info" style="background: rgba(0, 217, 255, 0.1); border: 1px solid var(--primary); color: var(--text-primary);">
          <i class="fas fa-info-circle"></i> <strong>Tip:</strong> Haz clic en cualquier monto para editarlo directamente
        </div>

        <div class="card">
          <div class="card-body">
            <table class="estado-resultados-tabla">
              <tbody>
                <!-- VENTAS -->
                <tr class="titulo-seccion">
                  <td class="concepto">VENTAS</td>
                  <td class="monto"><span class="monto-editable" onclick="abrirModalEdicion('Ventas')">0.00</span></td>
                </tr>
                <tr>
                  <td class="concepto">(-) Descuento sobre ventas</td>
                  <td class="monto"><span class="monto-editable" onclick="abrirModalEdicion('Descuento sobre ventas')">0.00</span></td>
                </tr>
                <tr>
                  <td class="concepto">(-) Devoluciones sobre ventas</td>
                  <td class="monto"><span class="monto-editable" onclick="abrirModalEdicion('Devoluciones sobre ventas')">0.00</span></td>
                </tr>
                <tr class="subtotal">
                  <td class="concepto"><strong>= VENTAS NETAS</strong></td>
                  <td class="monto"><strong id="ventasNetas">0.00</strong></td>
                </tr>

                <!-- COSTO DE VENTAS -->
                <tr class="titulo-seccion">
                  <td class="concepto">(-) COSTO DE VENTAS</td>
                  <td class="monto"></td>
                </tr>
                <tr>
                  <td class="concepto" style="padding-left: 40px;">Inventario inicial</td>
                  <td class="monto"><span class="monto-editable" onclick="abrirModalEdicion('Inventario inicial')">0.00</span></td>
                </tr>
                <tr>
                  <td class="concepto" style="padding-left: 40px;">+ Compras netas</td>
                  <td class="monto"></td>
                </tr>
                <tr>
                  <td class="concepto" style="padding-left: 60px;">Compras</td>
                  <td class="monto"><span class="monto-editable" onclick="abrirModalEdicion('Compras')">0.00</span></td>
                </tr>
                <tr>
                  <td class="concepto" style="padding-left: 60px;">+ Gastos sobre compras</td>
                  <td class="monto"><span class="monto-editable" onclick="abrirModalEdicion('Gastos sobre compras')">0.00</span></td>
                </tr>
                <tr class="subtotal" style="padding-left: 60px;">
                  <td class="concepto" style="padding-left: 60px;">= Compras totales</td>
                  <td class="monto"><strong id="comprasTotales">0.00</strong></td>
                </tr>
                <tr>
                  <td class="concepto" style="padding-left: 60px;">(-) Descuento sobre compras</td>
                  <td class="monto"><span class="monto-editable" onclick="abrirModalEdicion('Descuento sobre compras')">0.00</span></td>
                </tr>
                <tr>
                  <td class="concepto" style="padding-left: 60px;">(-) Devoluciones sobre compras</td>
                  <td class="monto"><span class="monto-editable" onclick="abrirModalEdicion('Devoluciones sobre compras')">0.00</span></td>
                </tr>
                <tr class="subtotal">
                  <td class="concepto" style="padding-left: 40px;">= Compras netas</td>
                  <td class="monto"><strong id="comprasNetas">0.00</strong></td>
                </tr>
                <tr class="subtotal">
                  <td class="concepto" style="padding-left: 40px;">= Mercadería disponible para la venta</td>
                  <td class="monto"><strong id="mercaderiaDisponible">0.00</strong></td>
                </tr>
                <tr>
                  <td class="concepto" style="padding-left: 40px;">(-) Inventario final</td>
                  <td class="monto"><span class="monto-editable" onclick="abrirModalEdicion('Inventario final')">0.00</span></td>
                </tr>
                <tr class="subtotal">
                  <td class="concepto"><strong>= COSTO DE VENTAS</strong></td>
                  <td class="monto"><strong id="costoVentas">0.00</strong></td>
                </tr>

                <!-- UTILIDAD BRUTA -->
                <tr class="subtotal">
                  <td class="concepto"><strong>= UTILIDAD (PÉRDIDA) BRUTA</strong></td>
                  <td class="monto"><strong id="utilidadBruta">0.00</strong></td>
                </tr>

                <!-- GASTOS OPERATIVOS -->
                <tr class="titulo-seccion">
                  <td class="concepto">(-) GASTOS OPERATIVOS</td>
                  <td class="monto"></td>
                </tr>
                <tr>
                  <td class="concepto" style="padding-left: 40px;">Gastos de administración</td>
                  <td class="monto"><span class="monto-editable" onclick="abrirModalEdicion('Gastos de administración')">0.00</span></td>
                </tr>
                <tr>
                  <td class="concepto" style="padding-left: 40px;">+ Gastos de ventas</td>
                  <td class="monto"><span class="monto-editable" onclick="abrirModalEdicion('Gastos de ventas')">0.00</span></td>
                </tr>
                <tr class="subtotal">
                  <td class="concepto"><strong>= UTILIDAD (PÉRDIDA) OPERATIVA</strong></td>
                  <td class="monto"><strong id="utilidadOperativa">0.00</strong></td>
                </tr>

                <!-- PRODUCTOS Y GASTOS FINANCIEROS -->
                <tr class="titulo-seccion">
                  <td class="concepto">± PRODUCTOS Y GASTOS FINANCIEROS</td>
                  <td class="monto"><span class="monto-editable" onclick="abrirModalEdicion('Gastos financieros')">0.00</span></td>
                </tr>

                <!-- OTROS INGRESOS Y GASTOS -->
                <tr class="titulo-seccion">
                  <td class="concepto">± OTROS INGRESOS Y GASTOS</td>
                  <td class="monto"><span class="monto-editable" onclick="abrirModalEdicion('Otros ingresos y gastos')">0.00</span></td>
                </tr>

                <!-- UTILIDAD ANTES DEL ISR -->
                <tr class="subtotal">
                  <td class="concepto"><strong>= UTILIDAD ANTES DEL ISR (PÉRDIDA DEL PERÍODO)</strong></td>
                  <td class="monto"><strong id="utilidadAntesISR">0.00</strong></td>
                </tr>

                <!-- IMPUESTO SOBRE LA RENTA -->
                <tr>
                  <td class="concepto">(-) IMPUESTO SOBRE LA RENTA</td>
                  <td class="monto"><span class="monto-editable" onclick="abrirModalEdicion('Impuesto sobre la renta')">0.00</span></td>
                </tr>

                <!-- UTILIDAD DEL PERÍODO -->
                <tr class="total-final">
                  <td class="concepto"><strong>= UTILIDAD DEL PERÍODO</strong></td>
                  <td class="monto"><strong id="utilidadPeriodo">0.00</strong></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- BALANCE GENERAL -->
      <div class="tab-pane fade" id="contenido-bg" role="tabpanel">
        <h2 style="font-size: 1.8rem; font-weight: 800; color: var(--primary); margin-top: 30px; margin-bottom: 30px; border-bottom: 2px solid var(--primary); padding-bottom: 15px;">
          <i class="fas fa-building"></i> Balance General
        </h2>

        <div class="alert alert-info" style="background: rgba(0, 217, 255, 0.1); border: 1px solid var(--primary); color: var(--text-primary);">
          <i class="fas fa-info-circle"></i> <strong>Tip:</strong> Haz clic en cualquier monto para editarlo directamente
        </div>

        <div class="row">
          <!-- ACTIVO -->
          <div class="col-lg-6">
            <div class="card">
              <div class="card-header">
                <i class="fas fa-arrow-right"></i> ACTIVO
              </div>
              <div class="card-body">
                <table class="estado-resultados-tabla">
                  <tbody>
                    <!-- ACTIVO CIRCULANTE -->
                    <tr class="titulo-seccion">
                      <td class="concepto">ACTIVO CIRCULANTE</td>
                      <td class="monto"></td>
                    </tr>
                    <tr>
                      <td class="concepto" style="padding-left: 40px;">Caja y bancos</td>
                      <td class="monto"><span class="monto-editable" onclick="abrirModalEdicion('Caja y bancos')">0.00</span></td>
                    </tr>
                    <tr>
                      <td class="concepto" style="padding-left: 40px;">Cuentas por cobrar</td>
                      <td class="monto"><span class="monto-editable" onclick="abrirModalEdicion('Cuentas por cobrar')">0.00</span></td>
                    </tr>
                    <tr>
                      <td class="concepto" style="padding-left: 40px;">Inventarios</td>
                      <td class="monto"><span class="monto-editable" onclick="abrirModalEdicion('Inventarios')">0.00</span></td>
                    </tr>
                    <tr>
                      <td class="concepto" style="padding-left: 40px;">Otros activos circulantes</td>
                      <td class="monto"><span class="monto-editable" onclick="abrirModalEdicion('Otros activos circulantes')">0.00</span></td>
                    </tr>
                    <tr class="subtotal">
                      <td class="concepto"><strong>= TOTAL ACTIVO CIRCULANTE</strong></td>
                      <td class="monto"><strong id="totalActivoCirculante">0.00</strong></td>
                    </tr>

                    <!-- ACTIVO NO CIRCULANTE -->
                    <tr class="titulo-seccion">
                      <td class="concepto">ACTIVO NO CIRCULANTE</td>
                      <td class="monto"></td>
                    </tr>
                    <tr>
                      <td class="concepto" style="padding-left: 40px;">Propiedad, planta y equipo</td>
                      <td class="monto"><span class="monto-editable" onclick="abrirModalEdicion('Propiedad, planta y equipo')">0.00</span></td>
                    </tr>
                    <tr>
                      <td class="concepto" style="padding-left: 40px;">(-) Depreciación acumulada</td>
                      <td class="monto"><span class="monto-editable" onclick="abrirModalEdicion('Depreciación acumulada')">0.00</span></td>
                    </tr>
                    <tr>
                      <td class="concepto" style="padding-left: 40px;">Activos intangibles</td>
                      <td class="monto"><span class="monto-editable" onclick="abrirModalEdicion('Activos intangibles')">0.00</span></td>
                    </tr>
                    <tr>
                      <td class="concepto" style="padding-left: 40px;">Otros activos no circulantes</td>
                      <td class="monto"><span class="monto-editable" onclick="abrirModalEdicion('Otros activos no circulantes')">0.00</span></td>
                    </tr>
                    <tr class="subtotal">
                      <td class="concepto"><strong>= TOTAL ACTIVO NO CIRCULANTE</strong></td>
                      <td class="monto"><strong id="totalActivoNoCirulante">0.00</strong></td>
                    </tr>

                    <!-- TOTAL ACTIVO -->
                    <tr class="total-final">
                      <td class="concepto"><strong>= TOTAL ACTIVO</strong></td>
                      <td class="monto"><strong id="totalActivo">0.00</strong></td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- PASIVO Y CAPITAL -->
          <div class="col-lg-6">
            <div class="card">
              <div class="card-header">
                <i class="fas fa-arrow-left"></i> PASIVO Y CAPITAL
              </div>
              <div class="card-body">
                <table class="estado-resultados-tabla">
                  <tbody>
                    <!-- PASIVO CIRCULANTE -->
                    <tr class="titulo-seccion">
                      <td class="concepto">PASIVO CIRCULANTE</td>
                      <td class="monto"></td>
                    </tr>
                    <tr>
                      <td class="concepto" style="padding-left: 40px;">Cuentas por pagar</td>
                      <td class="monto"><span class="monto-editable" onclick="abrirModalEdicion('Cuentas por pagar')">0.00</span></td>
                    </tr>
                    <tr>
                      <td class="concepto" style="padding-left: 40px;">Impuestos por pagar</td>
                      <td class="monto"><span class="monto-editable" onclick="abrirModalEdicion('Impuestos por pagar')">0.00</span></td>
                    </tr>
                    <tr>
                      <td class="concepto" style="padding-left: 40px;">Porción circulante de deuda a largo plazo</td>
                      <td class="monto"><span class="monto-editable" onclick="abrirModalEdicion('Porción circulante de deuda')">0.00</span></td>
                    </tr>
                    <tr>
                      <td class="concepto" style="padding-left: 40px;">Otros pasivos circulantes</td>
                      <td class="monto"><span class="monto-editable" onclick="abrirModalEdicion('Otros pasivos circulantes')">0.00</span></td>
                    </tr>
                    <tr class="subtotal">
                      <td class="concepto"><strong>= TOTAL PASIVO CIRCULANTE</strong></td>
                      <td class="monto"><strong id="totalPasivoCirculante">0.00</strong></td>
                    </tr>

                    <!-- PASIVO NO CIRCULANTE -->
                    <tr class="titulo-seccion">
                      <td class="concepto">PASIVO NO CIRCULANTE</td>
                      <td class="monto"></td>
                    </tr>
                    <tr>
                      <td class="concepto" style="padding-left: 40px;">Deuda a largo plazo</td>
                      <td class="monto"><span class="monto-editable" onclick="abrirModalEdicion('Deuda a largo plazo')">0.00</span></td>
                    </tr>
                    <tr>
                      <td class="concepto" style="padding-left: 40px;">Obligaciones por pensiones</td>
                      <td class="monto"><span class="monto-editable" onclick="abrirModalEdicion('Obligaciones por pensiones')">0.00</span></td>
                    </tr>
                    <tr>
                      <td class="concepto" style="padding-left: 40px;">Otros pasivos no circulantes</td>
                      <td class="monto"><span class="monto-editable" onclick="abrirModalEdicion('Otros pasivos no circulantes')">0.00</span></td>
                    </tr>
                    <tr class="subtotal">
                      <td class="concepto"><strong>= TOTAL PASIVO NO CIRCULANTE</strong></td>
                      <td class="monto"><strong id="totalPasivoNoCirulante">0.00</strong></td>
                    </tr>

                    <!-- TOTAL PASIVO -->
                    <tr class="subtotal">
                      <td class="concepto"><strong>= TOTAL PASIVO</strong></td>
                      <td class="monto"><strong id="totalPasivo">0.00</strong></td>
                    </tr>

                    <!-- CAPITAL -->
                    <tr class="titulo-seccion">
                      <td class="concepto">CAPITAL / PATRIMONIO</td>
                      <td class="monto"></td>
                    </tr>
                    <tr>
                      <td class="concepto" style="padding-left: 40px;">Capital social</td>
                      <td class="monto"><span class="monto-editable" onclick="abrirModalEdicion('Capital social')">0.00</span></td>
                    </tr>
                    <tr>
                      <td class="concepto" style="padding-left: 40px;">Reservas</td>
                      <td class="monto"><span class="monto-editable" onclick="abrirModalEdicion('Reservas')">0.00</span></td>
                    </tr>
                    <tr>
                      <td class="concepto" style="padding-left: 40px;">Ganancias acumuladas</td>
                      <td class="monto"><span class="monto-editable" onclick="abrirModalEdicion('Ganancias acumuladas')">0.00</span></td>
                    </tr>
                    <tr class="subtotal">
                      <td class="concepto"><strong>= TOTAL CAPITAL</strong></td>
                      <td class="monto"><strong id="totalCapital">0.00</strong></td>
                    </tr>

                    <!-- TOTAL PASIVO Y CAPITAL -->
                    <tr class="total-final">
                      <td class="concepto"><strong>= TOTAL PASIVO Y CAPITAL</strong></td>
                      <td class="monto"><strong id="totalPasivoCapital">0.00</strong></td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ANÁLISIS VERTICAL -->
      <div class="tab-pane fade" id="contenido-analisis" role="tabpanel">
        <h2 style="font-size: 1.8rem; font-weight: 800; color: var(--primary); margin-top: 30px; margin-bottom: 30px; border-bottom: 2px solid var(--primary); padding-bottom: 15px;">
          <i class="fas fa-chart-bar"></i> Análisis Vertical
        </h2>

        <div class="row">
          <!-- ANÁLISIS ESTADO DE RESULTADOS -->
          <div class="col-lg-6">
            <div class="card">
              <div class="card-header">
                <i class="fas fa-file-invoice-dollar"></i> Estado de Resultados (% sobre Ventas Netas)
              </div>
              <div class="card-body">
                <table class="analisis-tabla">
                  <tbody id="analisisER">
                    <tr><td colspan="3" class="empty-state"><i class="fas fa-inbox"></i> Sin datos</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- ANÁLISIS BALANCE GENERAL -->
          <div class="col-lg-6">
            <div class="card">
              <div class="card-header">
                <i class="fas fa-building"></i> Balance General (% sobre Total Activo)
              </div>
              <div class="card-body">
                <table class="analisis-tabla">
                  <tbody id="analysisBG">
                    <tr><td colspan="3" class="empty-state"><i class="fas fa-inbox"></i> Sin datos</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- INDICADORES FINANCIEROS -->
        <div class="card mt-4">
          <div class="card-header">
            <i class="fas fa-tachometer-alt"></i> Indicadores Financieros Clave
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-3">
                <div class="metric-card">
                  <div class="metric-value" id="margenBruto">0.00%</div>
                  <div class="metric-label">Margen Bruto</div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="metric-card">
                  <div class="metric-value" id="margenOperativo">0.00%</div>
                  <div class="metric-label">Margen Operativo</div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="metric-card">
                  <div class="metric-value" id="margenNeto">0.00%</div>
                  <div class="metric-label">Margen Neto</div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="metric-card">
                  <div class="metric-value" id="razonDeuda">0.00%</div>
                  <div class="metric-label">Razón de Deuda</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
</div>

<!-- Modal de Edición -->
<div class="modal fade" id="modalEdicion" tabindex="-1">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-edit"></i> Editar Monto</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <label class="form-label" style="color: var(--primary); font-weight: 700;" id="labelConcepto"></label>
        <input type="number" id="inputMonto" class="input-monto-modal" placeholder="0.00" step="0.01">
      </div>
      <div class="modal-footer" style="border-top: 1px solid var(--border-color);">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary-glow" onclick="guardarEdicion()">
          <i class="fas fa-save"></i> Guardar
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  let datosFinancieros = {
    // Estado de Resultados
    'Ventas': 0,
    'Descuento sobre ventas': 0,
    'Devoluciones sobre ventas': 0,
    'Inventario inicial': 0,
    'Compras': 0,
    'Gastos sobre compras': 0,
    'Descuento sobre compras': 0,
    'Devoluciones sobre compras': 0,
    'Inventario final': 0,
    'Gastos de administración': 0,
    'Gastos de ventas': 0,
    'Gastos financieros': 0,
    'Otros ingresos y gastos': 0,
    'Impuesto sobre la renta': 0,
    // Balance General - Activo Circulante
    'Caja y bancos': 0,
    'Cuentas por cobrar': 0,
    'Inventarios': 0,
    'Otros activos circulantes': 0,
    // Balance General - Activo No Circulante
    'Propiedad, planta y equipo': 0,
    'Depreciación acumulada': 0,
    'Activos intangibles': 0,
    'Otros activos no circulantes': 0,
    // Balance General - Pasivo Circulante
    'Cuentas por pagar': 0,
    'Impuestos por pagar': 0,
    'Porción circulante de deuda': 0,
    'Otros pasivos circulantes': 0,
    // Balance General - Pasivo No Circulante
    'Deuda a largo plazo': 0,
    'Obligaciones por pensiones': 0,
    'Otros pasivos no circulantes': 0,
    // Balance General - Capital
    'Capital social': 0,
    'Reservas': 0,
    'Ganancias acumuladas': 0
  };

  let conceptoActual = null;

  function abrirModalEdicion(concepto) {
    conceptoActual = concepto;
    document.getElementById('labelConcepto').textContent = concepto;
    document.getElementById('inputMonto').value = datosFinancieros[concepto] || 0;
    
    const modal = new bootstrap.Modal(document.getElementById('modalEdicion'));
    modal.show();
    
    setTimeout(() => {
      document.getElementById('inputMonto').focus();
      document.getElementById('inputMonto').select();
    }, 300);
  }

  function guardarEdicion() {
    const monto = parseFloat(document.getElementById('inputMonto').value) || 0;
    datosFinancieros[conceptoActual] = monto;
    
    const modal = bootstrap.Modal.getInstance(document.getElementById('modalEdicion'));
    modal.hide();
    
    actualizarTablas();
  }

  function actualizarTablas() {
    // Cálculos Estado de Resultados
    const ventas = datosFinancieros['Ventas'];
    const descuentoVentas = datosFinancieros['Descuento sobre ventas'];
    const devolucionesVentas = datosFinancieros['Devoluciones sobre ventas'];
    const ventasNetas = ventas - descuentoVentas - devolucionesVentas;

    const inventarioInicial = datosFinancieros['Inventario inicial'];
    const compras = datosFinancieros['Compras'];
    const gastosCompras = datosFinancieros['Gastos sobre compras'];
    const comprasTotales = compras + gastosCompras;
    const descuentoCompras = datosFinancieros['Descuento sobre compras'];
    const devolucionesCompras = datosFinancieros['Devoluciones sobre compras'];
    const comprasNetas = comprasTotales - descuentoCompras - devolucionesCompras;
    const mercaderiaDisponible = inventarioInicial + comprasNetas;
    const inventarioFinal = datosFinancieros['Inventario final'];
    const costoVentas = mercaderiaDisponible - inventarioFinal;

    const utilidadBruta = ventasNetas - costoVentas;
    const gastosAdmin = datosFinancieros['Gastos de administración'];
    const gastosVentas = datosFinancieros['Gastos de ventas'];
    const utilidadOperativa = utilidadBruta - gastosAdmin - gastosVentas;
    const gastosFinancieros = datosFinancieros['Gastos financieros'];
    const otrosIngresos = datosFinancieros['Otros ingresos y gastos'];
    const utilidadAntesISR = utilidadOperativa + gastosFinancieros + otrosIngresos;
    const impuestoRenta = datosFinancieros['Impuesto sobre la renta'];
    const utilidadPeriodo = utilidadAntesISR - impuestoRenta;

    // Actualizar Estado de Resultados
    document.getElementById('ventasNetas').textContent = ventasNetas.toLocaleString('es-ES', { minimumFractionDigits: 2 });
    document.getElementById('comprasTotales').textContent = comprasTotales.toLocaleString('es-ES', { minimumFractionDigits: 2 });
    document.getElementById('comprasNetas').textContent = comprasNetas.toLocaleString('es-ES', { minimumFractionDigits: 2 });
    document.getElementById('mercaderiaDisponible').textContent = mercaderiaDisponible.toLocaleString('es-ES', { minimumFractionDigits: 2 });
    document.getElementById('costoVentas').textContent = costoVentas.toLocaleString('es-ES', { minimumFractionDigits: 2 });
    document.getElementById('utilidadBruta').textContent = utilidadBruta.toLocaleString('es-ES', { minimumFractionDigits: 2 });
    document.getElementById('utilidadOperativa').textContent = utilidadOperativa.toLocaleString('es-ES', { minimumFractionDigits: 2 });
    document.getElementById('utilidadAntesISR').textContent = utilidadAntesISR.toLocaleString('es-ES', { minimumFractionDigits: 2 });
    document.getElementById('utilidadPeriodo').textContent = utilidadPeriodo.toLocaleString('es-ES', { minimumFractionDigits: 2 });

    // Actualizar Balance General
    const totalActivoCirculante = datosFinancieros['Caja y bancos'] + datosFinancieros['Cuentas por cobrar'] + 
                                  datosFinancieros['Inventarios'] + datosFinancieros['Otros activos circulantes'];
    
    const totalActivoNoCirulante = datosFinancieros['Propiedad, planta y equipo'] - datosFinancieros['Depreciación acumulada'] + 
                                   datosFinancieros['Activos intangibles'] + datosFinancieros['Otros activos no circulantes'];
    
    const totalActivo = totalActivoCirculante + totalActivoNoCirulante;

    const totalPasivoCirculante = datosFinancieros['Cuentas por pagar'] + datosFinancieros['Impuestos por pagar'] + 
                                  datosFinancieros['Porción circulante de deuda'] + datosFinancieros['Otros pasivos circulantes'];
    
    const totalPasivoNoCirulante = datosFinancieros['Deuda a largo plazo'] + datosFinancieros['Obligaciones por pensiones'] + 
                                   datosFinancieros['Otros pasivos no circulantes'];
    
    const totalPasivo = totalPasivoCirculante + totalPasivoNoCirulante;

    const totalCapital = datosFinancieros['Capital social'] + datosFinancieros['Reservas'] + datosFinancieros['Ganancias acumuladas'];

    // Actualizar Balance General
    document.getElementById('totalActivoCirculante').textContent = totalActivoCirculante.toLocaleString('es-ES', { minimumFractionDigits: 2 });
    document.getElementById('totalActivoNoCirulante').textContent = totalActivoNoCirulante.toLocaleString('es-ES', { minimumFractionDigits: 2 });
    document.getElementById('totalActivo').textContent = totalActivo.toLocaleString('es-ES', { minimumFractionDigits: 2 });
    document.getElementById('totalPasivoCirculante').textContent = totalPasivoCirculante.toLocaleString('es-ES', { minimumFractionDigits: 2 });
    document.getElementById('totalPasivoNoCirulante').textContent = totalPasivoNoCirulante.toLocaleString('es-ES', { minimumFractionDigits: 2 });
    document.getElementById('totalPasivo').textContent = totalPasivo.toLocaleString('es-ES', { minimumFractionDigits: 2 });
    document.getElementById('totalCapital').textContent = totalCapital.toLocaleString('es-ES', { minimumFractionDigits: 2 });
    document.getElementById('totalPasivoCapital').textContent = (totalPasivo + totalCapital).toLocaleString('es-ES', { minimumFractionDigits: 2 });

    // Actualizar todos los montos editables
    document.querySelectorAll('.monto-editable').forEach(span => {
      const concepto = span.getAttribute('onclick').match(/'([^']+)'/)[1];
      span.textContent = (datosFinancieros[concepto] || 0).toLocaleString('es-ES', { minimumFractionDigits: 2 });
    });

    // Actualizar Análisis Vertical
    actualizarAnalisisVertical(ventasNetas, totalActivo, utilidadBruta, utilidadOperativa, utilidadPeriodo, totalPasivo);
  }

  function actualizarAnalisisVertical(ventasNetas, totalActivo, utilidadBruta, utilidadOperativa, utilidadPeriodo, totalPasivo) {
    // Análisis Estado de Resultados
    const costoVentas = datosFinancieros['Inventario inicial'] + 
                       (datosFinancieros['Compras'] + datosFinancieros['Gastos sobre compras'] - 
                        datosFinancieros['Descuento sobre compras'] - datosFinancieros['Devoluciones sobre compras']) - 
                       datosFinancieros['Inventario final'];
    
    const gastosAdmin = datosFinancieros['Gastos de administración'];
    const gastosVentas = datosFinancieros['Gastos de ventas'];

    const analisisER = `
      <tr class="titulo-seccion">
        <td class="concepto">VENTAS NETAS</td>
        <td class="valor">${ventasNetas.toLocaleString('es-ES', { minimumFractionDigits: 2 })}</td>
        <td class="porcentaje"><strong>100.00%</strong></td>
      </tr>
      <tr>
        <td class="concepto">(-) Costo de Ventas</td>
        <td class="valor">${costoVentas.toLocaleString('es-ES', { minimumFractionDigits: 2 })}</td>
        <td class="porcentaje">${ventasNetas > 0 ? ((costoVentas / ventasNetas) * 100).toFixed(2) : 0}%</td>
      </tr>
      <tr class="subtotal">
        <td class="concepto"><strong>Utilidad Bruta</strong></td>
        <td class="valor"><strong>${utilidadBruta.toLocaleString('es-ES', { minimumFractionDigits: 2 })}</strong></td>
        <td class="porcentaje"><strong>${ventasNetas > 0 ? ((utilidadBruta / ventasNetas) * 100).toFixed(2) : 0}%</strong></td>
      </tr>
      <tr>
        <td class="concepto">(-) Gastos de Administración</td>
        <td class="valor">${gastosAdmin.toLocaleString('es-ES', { minimumFractionDigits: 2 })}</td>
        <td class="porcentaje">${ventasNetas > 0 ? ((gastosAdmin / ventasNetas) * 100).toFixed(2) : 0}%</td>
      </tr>
      <tr>
        <td class="concepto">(-) Gastos de Ventas</td>
        <td class="valor">${gastosVentas.toLocaleString('es-ES', { minimumFractionDigits: 2 })}</td>
        <td class="porcentaje">${ventasNetas > 0 ? ((gastosVentas / ventasNetas) * 100).toFixed(2) : 0}%</td>
      </tr>
      <tr class="subtotal">
        <td class="concepto"><strong>Utilidad Operativa</strong></td>
        <td class="valor"><strong>${utilidadOperativa.toLocaleString('es-ES', { minimumFractionDigits: 2 })}</strong></td>
        <td class="porcentaje"><strong>${ventasNetas > 0 ? ((utilidadOperativa / ventasNetas) * 100).toFixed(2) : 0}%</strong></td>
      </tr>
      <tr class="total-final">
        <td class="concepto"><strong>Utilidad Neta</strong></td>
        <td class="valor"><strong>${utilidadPeriodo.toLocaleString('es-ES', { minimumFractionDigits: 2 })}</strong></td>
        <td class="porcentaje"><strong>${ventasNetas > 0 ? ((utilidadPeriodo / ventasNetas) * 100).toFixed(2) : 0}%</strong></td>
      </tr>
    `;

    document.getElementById('analisisER').innerHTML = analisisER;

    // Análisis Balance General
    const totalActivoCirculante = datosFinancieros['Caja y bancos'] + datosFinancieros['Cuentas por cobrar'] + 
                                  datosFinancieros['Inventarios'] + datosFinancieros['Otros activos circulantes'];
    
    const totalActivoNoCirulante = datosFinancieros['Propiedad, planta y equipo'] - datosFinancieros['Depreciación acumulada'] + 
                                   datosFinancieros['Activos intangibles'] + datosFinancieros['Otros activos no circulantes'];

    const analisisBG = `
      <tr class="titulo-seccion">
        <td class="concepto">ACTIVO CIRCULANTE</td>
        <td class="valor">${totalActivoCirculante.toLocaleString('es-ES', { minimumFractionDigits: 2 })}</td>
        <td class="porcentaje">${totalActivo > 0 ? ((totalActivoCirculante / totalActivo) * 100).toFixed(2) : 0}%</td>
      </tr>
      <tr class="subtotal">
        <td class="concepto"><strong>Activo No Circulante</strong></td>
        <td class="valor"><strong>${totalActivoNoCirulante.toLocaleString('es-ES', { minimumFractionDigits: 2 })}</strong></td>
        <td class="porcentaje"><strong>${totalActivo > 0 ? ((totalActivoNoCirulante / totalActivo) * 100).toFixed(2) : 0}%</strong></td>
      </tr>
      <tr class="titulo-seccion">
        <td class="concepto">TOTAL ACTIVO</td>
        <td class="valor">${totalActivo.toLocaleString('es-ES', { minimumFractionDigits: 2 })}</td>
        <td class="porcentaje"><strong>100.00%</strong></td>
      </tr>
      <tr>
        <td class="concepto">Pasivo Total</td>
        <td class="valor">${totalPasivo.toLocaleString('es-ES', { minimumFractionDigits: 2 })}</td>
        <td class="porcentaje">${totalActivo > 0 ? ((totalPasivo / totalActivo) * 100).toFixed(2) : 0}%</td>
      </tr>
      <tr class="total-final">
        <td class="concepto"><strong>Capital Total</strong></td>
        <td class="valor"><strong>${(totalActivo - totalPasivo).toLocaleString('es-ES', { minimumFractionDigits: 2 })}</strong></td>
        <td class="porcentaje"><strong>${totalActivo > 0 ? (((totalActivo - totalPasivo) / totalActivo) * 100).toFixed(2) : 0}%</strong></td>
      </tr>
    `;

    document.getElementById('analysisBG').innerHTML = analisisBG;

    // Indicadores Financieros
    const margenBruto = ventasNetas > 0 ? ((utilidadBruta / ventasNetas) * 100) : 0;
    const margenOperativo = ventasNetas > 0 ? ((utilidadOperativa / ventasNetas) * 100) : 0;
    const margenNeto = ventasNetas > 0 ? ((utilidadPeriodo / ventasNetas) * 100) : 0;
    const razonDeuda = totalActivo > 0 ? ((totalPasivo / totalActivo) * 100) : 0;

    document.getElementById('margenBruto').textContent = margenBruto.toFixed(2) + '%';
    document.getElementById('margenOperativo').textContent = margenOperativo.toFixed(2) + '%';
    document.getElementById('margenNeto').textContent = margenNeto.toFixed(2) + '%';
    document.getElementById('razonDeuda').textContent = razonDeuda.toFixed(2) + '%';

  }

  // Inicializar tablas con valores por defecto
  document.addEventListener('DOMContentLoaded', function() {
    actualizarTablas();
  });
  
</script>
{% endblock %}