{% extends 'base.html' %}

{% block title %}Presupuesto de Caja - DicksonStatistics{% endblock %}

{% block extra_css %}
<style>
    :root {
        --dark-bg: #0a0a12;
        --darker-bg: #07070f;
        --dark-card: #121225;
        --neon-purple: #8b5cf6;
        --neon-blue: #3b82f6;
        --neon-cyan: #06b6d4;
        --neon-pink: #ec4899;
        --white: #ffffff;
        --light-text: #f1f5f9;
        --medium-text: #94a3b8;
        --glow-purple: 0 0 20px rgba(139, 92, 246, 0.7);
        --glow-blue: 0 0 20px rgba(59, 130, 246, 0.7);
        --success-color: #10b981;
        --danger-color: #ef4444;
        --warning-color: #f59e0b;
    }
    
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        color: var(--light-text);
        line-height: 1.6;
        background-color: var(--dark-bg);
        overflow-x: hidden;
    }
    
    /* Background Animation */
    .bg-animation {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
        overflow: hidden;
    }
    
    .floating-shapes {
        position: absolute;
        width: 100%;
        height: 100%;
    }
    
    .shape {
        position: absolute;
        border-radius: 50%;
        background: rgba(139, 92, 246, 0.1);
        animation: float 15s infinite linear;
    }
    
    .shape:nth-child(1) {
        width: 80px;
        height: 80px;
        top: 20%;
        left: 10%;
        animation-delay: 0s;
    }
    
    .shape:nth-child(2) {
        width: 120px;
        height: 120px;
        top: 60%;
        left: 80%;
        animation-delay: -5s;
    }
    
    .shape:nth-child(3) {
        width: 60px;
        height: 60px;
        top: 80%;
        left: 20%;
        animation-delay: -10s;
    }
    
    @keyframes float {
        0% {
            transform: translateY(0) rotate(0deg);
            opacity: 0.5;
        }
        50% {
            transform: translateY(-20px) rotate(180deg);
            opacity: 0.8;
        }
        100% {
            transform: translateY(0) rotate(360deg);
            opacity: 0.5;
        }
    }
    
    .cash-budget-section {
        padding: 120px 0 60px;
        min-height: calc(100vh - 76px);
        position: relative;
    }
    
    .section-header {
        background: rgba(18, 18, 37, 0.8);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        padding: 2.5rem;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3), 0 0 50px rgba(139, 92, 246, 0.1);
        margin-bottom: 2rem;
        border: 1px solid rgba(139, 92, 246, 0.2);
        position: relative;
        overflow: hidden;
    }
    
    .section-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--neon-purple), var(--neon-cyan));
    }
    
    .section-title {
        font-size: 2.5rem;
        font-weight: 800;
        color: var(--white);
        margin-bottom: 0.5rem;
        text-shadow: var(--glow-purple);
    }
    
    .section-title .highlight {
        background: linear-gradient(90deg, var(--neon-purple), var(--neon-cyan));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    
    .section-subtitle {
        color: var(--medium-text);
        margin-bottom: 2rem;
        font-size: 1.1rem;
    }
    
    .control-panel {
        background: rgba(18, 18, 37, 0.8);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        padding: 2rem;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3), 0 0 50px rgba(139, 92, 246, 0.1);
        margin-bottom: 2rem;
        border: 1px solid rgba(139, 92, 246, 0.2);
        transition: all 0.3s ease;
    }
    
    .control-panel:hover {
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.4), 0 0 60px rgba(139, 92, 246, 0.2);
    }
    
    .btn-modern {
        padding: 0.875rem 1.75rem;
        border-radius: 12px;
        font-weight: 600;
        transition: all 0.3s ease;
        border: none;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        cursor: pointer;
        font-size: 0.95rem;
        position: relative;
        overflow: hidden;
    }
    
    .btn-modern::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
        transition: left 0.5s;
    }
    
    .btn-modern:hover::before {
        left: 100%;
    }
    
    .btn-primary-modern {
        background: linear-gradient(135deg, var(--neon-purple), var(--neon-blue));
        color: white;
        box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
    }
    
    .btn-primary-modern:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(139, 92, 246, 0.6);
        color: white;
    }
    
    .btn-outline-modern {
        background: transparent;
        border: 2px solid var(--neon-cyan);
        color: var(--neon-cyan);
    }
    
    .btn-outline-modern:hover {
        background: var(--neon-cyan);
        color: var(--dark-bg);
        transform: translateY(-3px);
        box-shadow: 0 6px 15px rgba(6, 182, 212, 0.4);
    }
    
    .btn-success-modern {
        background: var(--success-color);
        color: white;
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
    }
    
    .btn-success-modern:hover {
        background: #059669;
        transform: translateY(-3px);
        color: white;
        box-shadow: 0 8px 20px rgba(16, 185, 129, 0.6);
    }
    
    .btn-danger-modern {
        background: var(--danger-color);
        color: white;
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
    }
    
    .btn-danger-modern:hover {
        background: #dc2626;
        transform: translateY(-3px);
        color: white;
        box-shadow: 0 8px 20px rgba(239, 68, 68, 0.6);
    }
    
    .btn-warning-modern {
        background: var(--warning-color);
        color: white;
        box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
    }
    
    .btn-warning-modern:hover {
        background: #d97706;
        transform: translateY(-3px);
        color: white;
        box-shadow: 0 8px 20px rgba(245, 158, 11, 0.6);
    }
    
    .budget-table-container {
        background: rgba(18, 18, 37, 0.8);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3), 0 0 50px rgba(139, 92, 246, 0.1);
        overflow: hidden;
        border: 1px solid rgba(139, 92, 246, 0.2);
        margin-bottom: 2rem;
        transition: all 0.3s ease;
    }
    
    .budget-table-container:hover {
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.4), 0 0 60px rgba(139, 92, 246, 0.2);
    }
    
    .table-modern {
        margin: 0;
        border-collapse: separate;
        border-spacing: 0;
        width: 100%;
        background: transparent;
    }
    
    .table-modern thead th {
        background: linear-gradient(135deg, var(--neon-purple), var(--neon-blue));
        border-bottom: none;
        padding: 1.5rem 1rem;
        font-weight: 700;
        color: white;
        text-align: center;
        vertical-align: middle;
        font-size: 1.1rem;
        position: relative;
        text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
    }
    
    .table-modern thead th::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 10%;
        right: 10%;
        height: 2px;
        background: rgba(255, 255, 255, 0.5);
    }
    
    .table-modern tbody td {
        padding: 1.25rem 1rem;
        border-bottom: 1px solid rgba(139, 92, 246, 0.1);
        vertical-align: middle;
        transition: all 0.2s ease;
        background: transparent;
        color: var(--light-text);
        text-align: center;
    }
    
    .table-modern tbody tr:hover td {
        background: rgba(139, 92, 246, 0.1);
        transform: scale(1.01);
    }
    
    .table-modern .account-name {
        font-weight: 600;
        color: var(--light-text);
        min-width: 250px;
        font-size: 1rem;
        text-align: left;
    }
    
    /* CONTROLES NUMÉRICOS */
    .number-input-container {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        justify-content: center;
    }
    
    .number-input-wrapper {
        position: relative;
        display: flex;
        align-items: center;
        background: rgba(139, 92, 246, 0.1);
        border: 2px solid rgba(139, 92, 246, 0.3);
        border-radius: 10px;
        transition: all 0.3s ease;
        max-width: 150px;
        margin: 0 auto;
    }
    
    .number-input-wrapper:focus-within {
        border-color: var(--neon-purple);
        box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.2);
        background: rgba(139, 92, 246, 0.15);
    }
    
    .number-input {
        border: none;
        background: transparent;
        padding: 0.75rem 3rem 0.75rem 1rem;
        font-size: 1rem;
        font-weight: 500;
        color: var(--light-text);
        text-align: right;
        width: 100%;
        border-radius: 10px;
        outline: none;
    }
    
    .percentage-input {
        max-width: 100px;
        padding: 0.5rem 2.5rem 0.5rem 0.75rem;
    }
    
    .number-controls {
        position: absolute;
        right: 0;
        top: 0;
        bottom: 0;
        display: flex;
        flex-direction: column;
        width: 2rem;
        border-left: 1px solid rgba(139, 92, 246, 0.3);
    }
    
    .number-control {
        flex: 1;
        background: rgba(139, 92, 246, 0.2);
        border: none;
        color: var(--light-text);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
        font-size: 0.8rem;
    }
    
    .number-control:hover {
        background: rgba(139, 92, 246, 0.4);
    }
    
    .number-control:first-child {
        border-bottom: 1px solid rgba(139, 92, 246, 0.3);
    }
    
    .number-control:active {
        background: rgba(139, 92, 246, 0.6);
    }
    
    .month-header {
        background: linear-gradient(135deg, var(--neon-purple), var(--neon-blue)) !important;
        color: white !important;
        position: relative;
        text-shadow: 0 0 10px rgba(255, 255, 255, 0.7) !important;
        min-width: 150px;
    }
    
    .month-header span {
        color: white !important;
        font-weight: 700;
        text-shadow: 0 0 10px rgba(255, 255, 255, 0.7) !important;
    }
    
    .month-header small {
        color: rgba(255, 255, 255, 0.9) !important;
        font-weight: 500;
        text-shadow: 0 0 5px rgba(255, 255, 255, 0.5) !important;
    }
    
    /* FORM CONTROLS */
    .form-control-modern {
        border: 2px solid rgba(139, 92, 246, 0.3);
        border-radius: 12px;
        padding: 0.875rem 1.25rem;
        transition: all 0.3s ease;
        font-size: 1rem;
        background: rgba(139, 92, 246, 0.1);
        color: var(--light-text) !important;
    }
    
    .form-control-modern:focus {
        border-color: var(--neon-purple);
        box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.2);
        background: rgba(139, 92, 246, 0.15);
        color: var(--light-text) !important;
    }
    
    select.form-control-modern {
        color: var(--light-text) !important;
        background: rgba(139, 92, 246, 0.1) !important;
    }
    
    select.form-control-modern option {
        background: var(--dark-card) !important;
        color: var(--light-text) !important;
        padding: 10px;
    }
    
    select.form-control-modern:focus {
        background: rgba(139, 92, 246, 0.15) !important;
        color: var(--light-text) !important;
    }
    
    .calculation-row {
        background: rgba(6, 182, 212, 0.1) !important;
        font-weight: 700;
    }
    
    .calculation-row td {
        border-top: 2px solid rgba(139, 92, 246, 0.3);
    }
    
    .empty-row {
        text-align: center;
        color: var(--medium-text);
        font-style: italic;
        padding: 3rem !important;
        font-size: 1.1rem;
    }
    
    .action-buttons {
        display: flex;
        gap: 0.75rem;
        justify-content: center;
    }
    
    .btn-sm-modern {
        padding: 0.5rem 1rem;
        font-size: 0.9rem;
        border-radius: 8px;
    }
    
    .export-options {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
    }
    
    .modal-modern .modal-content {
        border-radius: 20px;
        border: none;
        box-shadow: 0 25px 80px rgba(0, 0, 0, 0.4);
        overflow: hidden;
        background: var(--dark-card);
        color: var(--light-text);
    }
    
    .modal-modern .modal-header {
        background: linear-gradient(135deg, var(--neon-purple), var(--neon-blue));
        color: white;
        border-radius: 20px 20px 0 0;
        border: none;
        padding: 1.75rem 2rem;
    }
    
    .modal-modern .modal-title {
        font-weight: 700;
        font-size: 1.5rem;
        text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
    }
    
    .modal-modern .btn-close {
        filter: invert(1);
        opacity: 0.8;
    }
    
    .modal-modern .btn-close:hover {
        opacity: 1;
    }
    
    .form-group-modern {
        margin-bottom: 1.75rem;
    }
    
    .form-label-modern {
        font-weight: 600;
        color: var(--light-text);
        margin-bottom: 0.75rem;
        font-size: 1rem;
    }
    
    .variation-badge {
        background: linear-gradient(135deg, var(--success-color), var(--neon-cyan));
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: 600;
        display: inline-block;
        margin-top: 0.5rem;
        box-shadow: 0 4px 10px rgba(16, 185, 129, 0.4);
        text-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
    }
    
    .variation-positive {
        background: linear-gradient(135deg, var(--success-color), var(--neon-cyan));
    }
    
    .variation-negative {
        background: linear-gradient(135deg, var(--danger-color), #f87171);
    }
    
    .variation-neutral {
        background: linear-gradient(135deg, var(--medium-text), #94a3b8);
    }
    
    .account-header-row {
        background-color: rgba(139, 92, 246, 0.2) !important;
        font-weight: 700;
    }
    
    .cash-flow-positive {
        color: var(--success-color);
        font-weight: 700;
    }
    
    .cash-flow-negative {
        color: var(--danger-color);
        font-weight: 700;
    }
    
    .cash-flow-neutral {
        color: var(--medium-text);
        font-weight: 700;
    }
    
    .file-upload-area {
        border: 2px dashed rgba(139, 92, 246, 0.5);
        border-radius: 16px;
        padding: 2.5rem;
        text-align: center;
        transition: all 0.3s ease;
        background: rgba(139, 92, 246, 0.05);
        cursor: pointer;
        position: relative;
    }
    
    .file-upload-area:hover {
        border-color: var(--neon-purple);
        background: rgba(139, 92, 246, 0.1);
        transform: translateY(-5px);
    }
    
    .file-upload-area.dragover {
        border-color: var(--neon-purple);
        background: rgba(139, 92, 246, 0.15);
        transform: scale(1.02);
    }
    
    .upload-icon {
        font-size: 3.5rem;
        color: var(--neon-purple);
        margin-bottom: 1rem;
        text-shadow: var(--glow-purple);
    }
    
    .file-input {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        opacity: 0;
        cursor: pointer;
    }
    
    .file-name {
        margin-top: 0.5rem;
        font-size: 1rem;
        color: var(--neon-purple);
        font-weight: 600;
        word-break: break-all;
        text-shadow: 0 0 10px rgba(139, 92, 246, 0.5);
    }
    
    /* CONFIGURATION PANEL */
    .configuration-panel {
        background: rgba(18, 18, 37, 0.8);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3), 0 0 50px rgba(139, 92, 246, 0.1);
        border: 1px solid rgba(139, 92, 246, 0.2);
        transition: all 0.3s ease;
    }
    
    .configuration-panel:hover {
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.4), 0 0 60px rgba(139, 92, 246, 0.2);
    }
    
    .config-item {
        background: rgba(139, 92, 246, 0.1);
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        border-left: 4px solid var(--neon-purple);
    }
    
    .config-item:last-child {
        margin-bottom: 0;
    }
    
    .config-title {
        font-weight: 700;
        color: var(--light-text);
        margin-bottom: 0.75rem;
        font-size: 1.1rem;
    }
    
    .config-description {
        color: var(--medium-text);
        font-size: 0.95rem;
        margin-bottom: 1rem;
    }
    
    .percentage-control {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .percentage-symbol {
        color: var(--neon-cyan);
        font-weight: 600;
    }
    
    /* Responsive Design */
    @media (max-width: 1200px) {
        .section-title {
            font-size: 2.25rem;
        }
    }

    @media (max-width: 992px) {
        .section-header {
            padding: 2rem;
        }
        
        .section-title {
            font-size: 2rem;
        }
        
        .configuration-panel {
            padding: 1.5rem;
        }
    }

    @media (max-width: 768px) {
        .cash-budget-section {
            padding: 100px 0 40px;
        }
        
        .section-header {
            padding: 1.5rem;
            border-radius: 16px;
        }
        
        .section-title {
            font-size: 1.75rem;
        }
        
        .section-subtitle {
            font-size: 1rem;
        }
        
        .control-panel, .configuration-panel {
            padding: 1.5rem;
            border-radius: 16px;
        }
        
        .table-responsive {
            font-size: 0.9rem;
        }
        
        .table-modern thead th,
        .table-modern tbody td {
            padding: 1rem 0.75rem;
        }
        
        .table-modern .account-name {
            min-width: 180px;
        }
        
        .number-input-wrapper {
            max-width: 130px;
        }
        
        .number-input {
            padding: 0.6rem 2.5rem 0.6rem 0.8rem;
            font-size: 0.9rem;
        }
        
        .percentage-input {
            max-width: 80px;
            padding: 0.5rem 2rem 0.5rem 0.6rem;
        }
        
        .number-controls {
            width: 1.8rem;
        }
        
        .export-options {
            flex-direction: column;
            width: 100%;
        }
        
        .export-options .btn-modern {
            width: 100%;
            justify-content: center;
        }
        
        .control-panel .d-flex {
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .control-panel .btn-modern {
            width: 100%;
            justify-content: center;
        }
        
        .btn-modern {
            padding: 0.75rem 1.5rem;
        }
    }

    @media (max-width: 576px) {
        .section-header {
            padding: 1.25rem;
        }
        
        .section-title {
            font-size: 1.5rem;
        }
        
        .control-panel, .configuration-panel {
            padding: 1.25rem;
            border-radius: 16px;
        }
        
        .table-modern thead th,
        .table-modern tbody td {
            padding: 0.75rem 0.5rem;
        }
        
        .table-modern .account-name {
            min-width: 150px;
            font-size: 0.9rem;
        }
        
        .number-input-wrapper {
            max-width: 110px;
        }
        
        .number-input {
            padding: 0.5rem 2rem 0.5rem 0.6rem;
            font-size: 0.85rem;
        }
        
        .percentage-input {
            max-width: 70px;
            padding: 0.4rem 1.8rem 0.4rem 0.5rem;
        }
        
        .number-controls {
            width: 1.6rem;
        }
        
        .btn-modern {
            font-size: 0.9rem;
            padding: 0.7rem 1.25rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Background Animation -->
<div class="bg-animation">
    <div class="floating-shapes">
        <div class="shape"></div>
        <div class="shape"></div>
        <div class="shape"></div>
    </div>
</div>

<section class="cash-budget-section">
    <div class="container">
        <!-- Header -->
        <div class="section-header">
            <h1 class="section-title">Presupuesto de <span class="highlight">Caja</span></h1>
            <p class="section-subtitle">Planificación y proyección de flujos de efectivo para la empresa</p>
        </div>

        <!-- Panel de Configuración de Porcentajes -->
        <div class="configuration-panel">
            <div class="row">
                <div class="col-md-6">
                    <div class="config-item">
                        <div class="config-title">Configuración Básica</div>
                        <div class="config-description">Define los parámetros iniciales del presupuesto</div>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label-modern">Saldo Inicial</label>
                                <div class="number-input-wrapper">
                                    <input type="number" class="number-input" id="initialBalance" value="15000" step="1000">
                                    <div class="number-controls">
                                        <button type="button" class="number-control increase" data-target="initialBalance">
                                            <i class="fas fa-chevron-up"></i>
                                        </button>
                                        <button type="button" class="number-control decrease" data-target="initialBalance">
                                            <i class="fas fa-chevron-down"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label-modern">Saldo Mínimo Requerido</label>
                                <div class="number-input-wrapper">
                                    <input type="number" class="number-input" id="minBalance" value="15000" step="1000">
                                    <div class="number-controls">
                                        <button type="button" class="number-control increase" data-target="minBalance">
                                            <i class="fas fa-chevron-up"></i>
                                        </button>
                                        <button type="button" class="number-control decrease" data-target="minBalance">
                                            <i class="fas fa-chevron-down"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="config-item">
                        <div class="config-title">Período de Proyección</div>
                        <div class="config-description">Selecciona los meses a proyectar</div>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label-modern">Mes Inicial</label>
                                <select class="form-control form-control-modern" id="startMonth">
                                    <option value="1">Enero</option>
                                    <option value="2">Febrero</option>
                                    <option value="3">Marzo</option>
                                    <option value="4">Abril</option>
                                    <option value="5">Mayo</option>
                                    <option value="6">Junio</option>
                                    <option value="7" selected>Julio</option>
                                    <option value="8">Agosto</option>
                                    <option value="9">Septiembre</option>
                                    <option value="10">Octubre</option>
                                    <option value="11">Noviembre</option>
                                    <option value="12">Diciembre</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label-modern">Cantidad de Meses</label>
                                <select class="form-control form-control-modern" id="monthsCount">
                                    <option value="3">3 meses</option>
                                    <option value="6" selected>6 meses</option>
                                    <option value="12">12 meses</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Porcentajes de Cobranzas -->
            <div class="config-item">
                <div class="config-title">Porcentajes de Cobranzas</div>
                <div class="config-description">Configura los porcentajes de cobro por mes</div>
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label-modern">Cobranza Mes Actual</label>
                        <div class="percentage-control">
                            <div class="number-input-wrapper">
                                <input type="number" class="number-input percentage-input" id="collectionCurrentMonth" value="12" step="0.1" min="0" max="100">
                                <div class="number-controls">
                                    <button type="button" class="number-control increase" data-target="collectionCurrentMonth">
                                        <i class="fas fa-chevron-up"></i>
                                    </button>
                                    <button type="button" class="number-control decrease" data-target="collectionCurrentMonth">
                                        <i class="fas fa-chevron-down"></i>
                                    </button>
                                </div>
                            </div>
                            <span class="percentage-symbol">%</span>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label-modern">Cobranza 1er Mes</label>
                        <div class="percentage-control">
                            <div class="number-input-wrapper">
                                <input type="number" class="number-input percentage-input" id="collectionFirstMonth" value="75" step="0.1" min="0" max="100">
                                <div class="number-controls">
                                    <button type="button" class="number-control increase" data-target="collectionFirstMonth">
                                        <i class="fas fa-chevron-up"></i>
                                    </button>
                                    <button type="button" class="number-control decrease" data-target="collectionFirstMonth">
                                        <i class="fas fa-chevron-down"></i>
                                    </button>
                                </div>
                            </div>
                            <span class="percentage-symbol">%</span>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label-modern">Cobranza 2do Mes</label>
                        <div class="percentage-control">
                            <div class="number-input-wrapper">
                                <input type="number" class="number-input percentage-input" id="collectionSecondMonth" value="13" step="0.1" min="0" max="100">
                                <div class="number-controls">
                                    <button type="button" class="number-control increase" data-target="collectionSecondMonth">
                                        <i class="fas fa-chevron-up"></i>
                                    </button>
                                    <button type="button" class="number-control decrease" data-target="collectionSecondMonth">
                                        <i class="fas fa-chevron-down"></i>
                                    </button>
                                </div>
                            </div>
                            <span class="percentage-symbol">%</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Porcentajes de Gastos -->
            <div class="config-item">
                <div class="config-title">Porcentajes de Gastos</div>
                <div class="config-description">Configura los porcentajes de gastos en relación a las ventas</div>
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label-modern">Compras (% de ventas)</label>
                        <div class="percentage-control">
                            <div class="number-input-wrapper">
                                <input type="number" class="number-input percentage-input" id="purchasesPercentage" value="60" step="0.1" min="0" max="100">
                                <div class="number-controls">
                                    <button type="button" class="number-control increase" data-target="purchasesPercentage">
                                        <i class="fas fa-chevron-up"></i>
                                    </button>
                                    <button type="button" class="number-control decrease" data-target="purchasesPercentage">
                                        <i class="fas fa-chevron-down"></i>
                                    </button>
                                </div>
                            </div>
                            <span class="percentage-symbol">%</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label-modern">Sueldos y Salarios</label>
                        <div class="percentage-control">
                            <div class="number-input-wrapper">
                                <input type="number" class="number-input percentage-input" id="salariesPercentage" value="6" step="0.1" min="0" max="100">
                                <div class="number-controls">
                                    <button type="button" class="number-control increase" data-target="salariesPercentage">
                                        <i class="fas fa-chevron-up"></i>
                                    </button>
                                    <button type="button" class="number-control decrease" data-target="salariesPercentage">
                                        <i class="fas fa-chevron-down"></i>
                                    </button>
                                </div>
                            </div>
                            <span class="percentage-symbol">%</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label-modern">Arrendamiento</label>
                        <div class="percentage-control">
                            <div class="number-input-wrapper">
                                <input type="number" class="number-input percentage-input" id="rentPercentage" value="2" step="0.1" min="0" max="100">
                                <div class="number-controls">
                                    <button type="button" class="number-control increase" data-target="rentPercentage">
                                        <i class="fas fa-chevron-up"></i>
                                    </button>
                                    <button type="button" class="number-control decrease" data-target="rentPercentage">
                                        <i class="fas fa-chevron-down"></i>
                                    </button>
                                </div>
                            </div>
                            <span class="percentage-symbol">%</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label-modern">Publicidad</label>
                        <div class="percentage-control">
                            <div class="number-input-wrapper">
                                <input type="number" class="number-input percentage-input" id="advertisingPercentage" value="3" step="0.1" min="0" max="100">
                                <div class="number-controls">
                                    <button type="button" class="number-control increase" data-target="advertisingPercentage">
                                        <i class="fas fa-chevron-up"></i>
                                    </button>
                                    <button type="button" class="number-control decrease" data-target="advertisingPercentage">
                                        <i class="fas fa-chevron-down"></i>
                                    </button>
                                </div>
                            </div>
                            <span class="percentage-symbol">%</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label-modern">Investigación y Desarrollo</label>
                        <div class="percentage-control">
                            <div class="number-input-wrapper">
                                <input type="number" class="number-input percentage-input" id="rndPercentage" value="12" step="0.1" min="0" max="100">
                                <div class="number-controls">
                                    <button type="button" class="number-control increase" data-target="rndPercentage">
                                        <i class="fas fa-chevron-up"></i>
                                    </button>
                                    <button type="button" class="number-control decrease" data-target="rndPercentage">
                                        <i class="fas fa-chevron-down"></i>
                                    </button>
                                </div>
                            </div>
                            <span class="percentage-symbol">%</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Cuentas Personalizadas -->
            <div class="config-item">
                <div class="config-title">Cuentas Personalizadas</div>
                <div class="config-description">Agrega cuentas especiales como seguros, impuestos, etc.</div>
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label-modern">Nombre de Cuenta</label>
                        <input type="text" class="form-control form-control-modern" id="customAccountName" placeholder="Ej: Pago de Seguro">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label-modern">Tipo</label>
                        <select class="form-control form-control-modern" id="customAccountType">
                            <option value="income">Ingreso</option>
                            <option value="expense">Egreso</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label-modern">Monto</label>
                        <div class="number-input-wrapper">
                            <input type="number" class="number-input" id="customAccountAmount" value="0" step="1000">
                            <div class="number-controls">
                                <button type="button" class="number-control increase" data-target="customAccountAmount">
                                    <i class="fas fa-chevron-up"></i>
                                </button>
                                <button type="button" class="number-control decrease" data-target="customAccountAmount">
                                    <i class="fas fa-chevron-down"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button class="btn btn-outline-modern btn-modern w-100" id="addCustomAccount">
                            <i class="fas fa-plus"></i> Agregar
                        </button>
                    </div>
                </div>
                
                <!-- Lista de Cuentas Personalizadas -->
                <div class="mt-3" id="customAccountsList">
                    <!-- Las cuentas personalizadas aparecerán aquí -->
                </div>
            </div>
        </div>

        <!-- Tabla de Presupuesto de Caja -->
        <div class="budget-table-container">
            <div class="table-responsive">
                <table class="table table-modern">
                    <thead>
                        <tr>
                            <th class="account-name">Concepto</th>
                            <!-- Encabezados de meses se generan dinámicamente -->
                        </tr>
                    </thead>
                    <tbody id="budgetTableBody">
                        <!-- Filas se generan dinámicamente -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Botones de Acción -->
        <div class="control-panel">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <div class="d-flex gap-2 flex-wrap">
                        <button class="btn btn-primary-modern btn-modern" id="calculateBudget">
                            <i class="fas fa-calculator"></i> Calcular Presupuesto
                        </button>
                        <button class="btn btn-outline-modern btn-modern" id="resetBudget">
                            <i class="fas fa-redo"></i> Reiniciar
                        </button>
                        <button class="btn btn-outline-modern btn-modern" data-bs-toggle="modal" data-bs-target="#importModal">
                            <i class="fas fa-file-import"></i> Importar desde Excel
                        </button>
                    </div>
                </div>
                <div class="col-md-4 text-md-end">
                    <div class="export-options">
                        <button class="btn btn-success-modern btn-modern" id="exportExcel">
                            <i class="fas fa-file-excel"></i> Exportar Excel
                        </button>
                        <button class="btn btn-outline-modern btn-modern" id="exportPDF">
                            <i class="fas fa-file-pdf"></i> Exportar PDF
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Modal para Importar Datos -->
<div class="modal fade modal-modern" id="importModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Importar desde Excel</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="file-upload-area" id="excelUploadArea">
                    <input type="file" class="file-input" id="excelFile" accept=".xlsx, .xls">
                    <div class="upload-icon">
                        <i class="fas fa-file-excel"></i>
                    </div>
                    <h5>Importar Presupuesto</h5>
                    <p class="text-muted">Haz clic aquí o arrastra tu archivo Excel</p>
                    <div class="file-name" id="excelFileName"></div>
                    <small class="text-muted">Formatos soportados: .xlsx, .xls</small>
                </div>
                
                <div class="mt-4">
                    <h6>Instrucciones de Importación:</h6>
                    <ul class="text-muted">
                        <li>El archivo debe tener la misma estructura que el presupuesto actual</li>
                        <li>La primera columna debe contener los conceptos</li>
                        <li>Las siguientes columnas deben ser los meses</li>
                        <li>Los datos importados reemplazarán la información actual</li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-modern btn-modern" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary-modern btn-modern" id="processImport">Procesar Archivo</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        let budgetData = {
            months: [],
            sales: [],
            collections: [],
            purchases: [],
            expenses: [],
            cashFlow: [],
            customAccounts: []
        };
        
        let selectedFile = null;
        
        // Inicializar presupuesto
        function initializeBudget() {
            generateMonths();
            initializeTable();
            setupEventListeners();
            calculateBudget();
        }
        
        // Generar meses basado en la configuración
        function generateMonths() {
            const startMonth = parseInt(document.getElementById('startMonth').value);
            const monthsCount = parseInt(document.getElementById('monthsCount').value);
            
            budgetData.months = [];
            const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                               'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            
            for (let i = 0; i < monthsCount; i++) {
                const monthIndex = (startMonth - 1 + i) % 12;
                budgetData.months.push(monthNames[monthIndex]);
            }
        }
        
        // Inicializar tabla
        function initializeTable() {
            generateTableHeaders();
            generateTableBody();
        }
        
        // Generar encabezados de la tabla
        function generateTableHeaders() {
            const thead = document.querySelector('.table-modern thead tr');
            thead.innerHTML = '<th class="account-name">Concepto</th>';
            
            budgetData.months.forEach(month => {
                thead.innerHTML += `
                    <th class="month-header">
                        ${month}
                        <br>
                        <small>2024</small>
                    </th>
                `;
            });
        }
        
        // Generar cuerpo de la tabla
        function generateTableBody() {
            const tbody = document.getElementById('budgetTableBody');
            tbody.innerHTML = '';
            
            // ENTRADAS DE EFECTIVO
            tbody.innerHTML += `
                <tr class="account-header-row">
                    <td class="account-name"><strong>ENTRADAS DE EFECTIVO</strong></td>
                    ${budgetData.months.map(() => '<td></td>').join('')}
                </tr>
            `;
            
            // Ventas
            tbody.innerHTML += `
                <tr>
                    <td class="account-name">Pronóstico de Ventas</td>
                    ${budgetData.months.map((month, index) => `
                        <td>
                            <div class="number-input-container">
                                <div class="number-input-wrapper">
                                    <input type="number" class="number-input sales-input" 
                                           data-month="${index}" value="0" step="1000">
                                    <div class="number-controls">
                                        <button type="button" class="number-control increase" data-target="sales" data-month="${index}">
                                            <i class="fas fa-chevron-up"></i>
                                        </button>
                                        <button type="button" class="number-control decrease" data-target="sales" data-month="${index}">
                                            <i class="fas fa-chevron-down"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </td>
                    `).join('')}
                </tr>
            `;
            
            // Cobranzas (se calculan automáticamente)
            tbody.innerHTML += `
                <tr>
                    <td class="account-name">Cobranzas - Mes Actual</td>
                    ${budgetData.months.map((month, index) => `
                        <td class="collection-cell" data-month="${index}" data-type="current">0</td>
                    `).join('')}
                </tr>
                <tr>
                    <td class="account-name">Cobranzas - 1er Mes</td>
                    ${budgetData.months.map((month, index) => `
                        <td class="collection-cell" data-month="${index}" data-type="first">0</td>
                    `).join('')}
                </tr>
                <tr>
                    <td class="account-name">Cobranzas - 2do Mes</td>
                    ${budgetData.months.map((month, index) => `
                        <td class="collection-cell" data-month="${index}" data-type="second">0</td>
                    `).join('')}
                </tr>
            `;
            
            // Total Entradas
            tbody.innerHTML += `
                <tr class="calculation-row">
                    <td class="account-name"><strong>TOTAL ENTRADAS</strong></td>
                    ${budgetData.months.map((month, index) => `
                        <td class="total-income-cell" data-month="${index}">0</td>
                    `).join('')}
                </tr>
            `;
            
            // SALIDAS DE EFECTIVO
            tbody.innerHTML += `
                <tr class="account-header-row">
                    <td class="account-name"><strong>SALIDAS DE EFECTIVO</strong></td>
                    ${budgetData.months.map(() => '<td></td>').join('')}
                </tr>
            `;
            
            // Compras
            tbody.innerHTML += `
                <tr>
                    <td class="account-name">Compras</td>
                    ${budgetData.months.map((month, index) => `
                        <td class="purchase-cell" data-month="${index}">0</td>
                    `).join('')}
                </tr>
            `;
            
            // Gastos Fijos
            const fixedExpenses = [
                { name: 'Sueldos y Salarios', id: 'salaries' },
                { name: 'Arrendamiento', id: 'rent' },
                { name: 'Publicidad', id: 'advertising' },
                { name: 'Investigación y Desarrollo', id: 'rnd' }
            ];
            
            fixedExpenses.forEach(expense => {
                tbody.innerHTML += `
                    <tr>
                        <td class="account-name">${expense.name}</td>
                        ${budgetData.months.map((month, index) => `
                            <td class="expense-cell" data-month="${index}" data-type="${expense.id}">0</td>
                        `).join('')}
                    </tr>
                `;
            });
            
            // Gastos Varios
            tbody.innerHTML += `
                <tr>
                    <td class="account-name">Gastos Varios</td>
                    ${budgetData.months.map((month, index) => `
                        <td>
                            <div class="number-input-container">
                                <div class="number-input-wrapper">
                                    <input type="number" class="number-input misc-expense-input" 
                                           data-month="${index}" value="5000" step="1000">
                                    <div class="number-controls">
                                        <button type="button" class="number-control increase" data-target="misc" data-month="${index}">
                                            <i class="fas fa-chevron-up"></i>
                                        </button>
                                        <button type="button" class="number-control decrease" data-target="misc" data-month="${index}">
                                            <i class="fas fa-chevron-down"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </td>
                    `).join('')}
                </tr>
            `;
            
            // Total Salidas
            tbody.innerHTML += `
                <tr class="calculation-row">
                    <td class="account-name"><strong>TOTAL SALIDAS</strong></td>
                    ${budgetData.months.map((month, index) => `
                        <td class="total-expense-cell" data-month="${index}">0</td>
                    `).join('')}
                </tr>
            `;
            
            // FLUJO DE EFECTIVO
            tbody.innerHTML += `
                <tr class="account-header-row">
                    <td class="account-name"><strong>FLUJO DE EFECTIVO</strong></td>
                    ${budgetData.months.map(() => '<td></td>').join('')}
                </tr>
                <tr class="calculation-row">
                    <td class="account-name">Flujo Neto de Efectivo</td>
                    ${budgetData.months.map((month, index) => `
                        <td class="cash-flow-cell" data-month="${index}">0</td>
                    `).join('')}
                </tr>
                <tr>
                    <td class="account-name">Saldo Inicial</td>
                    ${budgetData.months.map((month, index) => `
                        <td class="initial-balance-cell" data-month="${index}">${index === 0 ? document.getElementById('initialBalance').value : '0'}</td>
                    `).join('')}
                </tr>
                <tr class="calculation-row">
                    <td class="account-name"><strong>Saldo Final</strong></td>
                    ${budgetData.months.map((month, index) => `
                        <td class="final-balance-cell" data-month="${index}">0</td>
                    `).join('')}
                </tr>
                <tr>
                    <td class="account-name">Saldo Mínimo Requerido</td>
                    ${budgetData.months.map(() => `
                        <td>${document.getElementById('minBalance').value}</td>
                    `).join('')}
                </tr>
                <tr class="calculation-row">
                    <td class="account-name"><strong>Exceso/Deficit</strong></td>
                    ${budgetData.months.map((month, index) => `
                        <td class="balance-difference-cell" data-month="${index}">0</td>
                    `).join('')}
                </tr>
            `;
            
            // Agregar cuentas personalizadas
            addCustomAccountsToTable();
        }
        
        // Agregar cuentas personalizadas a la tabla
        function addCustomAccountsToTable() {
            const tbody = document.getElementById('budgetTableBody');
            
            // Remover cuentas personalizadas existentes
            document.querySelectorAll('.custom-account-row').forEach(row => row.remove());
            
            if (budgetData.customAccounts.length > 0) {
                // Insertar antes del flujo de efectivo
                const cashFlowHeader = tbody.querySelector('.account-header-row:last-child');
                
                budgetData.customAccounts.forEach(account => {
                    const customRow = document.createElement('tr');
                    customRow.className = 'custom-account-row';
                    customRow.setAttribute('data-account-id', account.id);
                    
                    let cellsHTML = `
                        <td class="account-name">${account.name}</td>
                        ${budgetData.months.map((month, index) => `
                            <td>
                                <div class="number-input-container">
                                    <div class="number-input-wrapper">
                                        <input type="number" class="number-input custom-account-input" 
                                               data-account="${account.id}" data-month="${index}" 
                                               value="${account.amount}" step="1000">
                                        <div class="number-controls">
                                            <button type="button" class="number-control increase" data-target="custom" data-account="${account.id}" data-month="${index}">
                                                <i class="fas fa-chevron-up"></i>
                                            </button>
                                            <button type="button" class="number-control decrease" data-target="custom" data-account="${account.id}" data-month="${index}">
                                                <i class="fas fa-chevron-down"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </td>
                        `).join('')}
                    `;
                    
                    customRow.innerHTML = cellsHTML;
                    tbody.insertBefore(customRow, cashFlowHeader);
                });
            }
        }
        
        // Calcular presupuesto completo
        function calculateBudget() {
            calculateCollections();
            calculatePurchases();
            calculateExpenses();
            calculateCashFlow();
            updateTableValues();
        }
        
        // Calcular cobranzas (réplica exacta de Excel)
        function calculateCollections() {
            const salesInputs = document.querySelectorAll('.sales-input');
            budgetData.sales = Array.from(salesInputs).map(input => parseFloat(input.value) || 0);
            
            // Obtener porcentajes configurables
            const currentMonthPercent = parseFloat(document.getElementById('collectionCurrentMonth').value) / 100;
            const firstMonthPercent = parseFloat(document.getElementById('collectionFirstMonth').value) / 100;
            const secondMonthPercent = parseFloat(document.getElementById('collectionSecondMonth').value) / 100;
            
            budgetData.collections = budgetData.months.map((month, index) => {
                const currentMonthSales = budgetData.sales[index] || 0;
                const firstMonthSales = index > 0 ? budgetData.sales[index - 1] || 0 : 0;
                const secondMonthSales = index > 1 ? budgetData.sales[index - 2] || 0 : 0;
                
                // Réplica exacta de las fórmulas de Excel
                return {
                    current: currentMonthSales * currentMonthPercent,      // =D4*12%
                    first: firstMonthSales * firstMonthPercent,           // =C4*75%
                    second: secondMonthSales * secondMonthPercent         // =B4*13%
                };
            });
        }
        
        // Calcular compras (réplica exacta de Excel)
        function calculatePurchases() {
            const purchasesPercent = parseFloat(document.getElementById('purchasesPercentage').value) / 100;
            
            budgetData.purchases = budgetData.months.map((month, index) => {
                const sales = budgetData.sales[index] || 0;
                // Réplica de: =0.6*D4 (pero con porcentaje configurable)
                return sales * purchasesPercent;
            });
        }
        
        // Calcular gastos (réplica exacta de Excel)
        function calculateExpenses() {
            const miscInputs = document.querySelectorAll('.misc-expense-input');
            const miscExpenses = Array.from(miscInputs).map(input => parseFloat(input.value) || 0);
            
            // Obtener porcentajes configurables
            const salariesPercent = parseFloat(document.getElementById('salariesPercentage').value) / 100;
            const rentPercent = parseFloat(document.getElementById('rentPercentage').value) / 100;
            const advertisingPercent = parseFloat(document.getElementById('advertisingPercentage').value) / 100;
            const rndPercent = parseFloat(document.getElementById('rndPercentage').value) / 100;
            
            budgetData.expenses = budgetData.months.map((month, index) => {
                const sales = budgetData.sales[index] || 0;
                
                // Réplica exacta de las fórmulas de Excel
                return {
                    salaries: sales * salariesPercent,        // =D4*6%
                    rent: sales * rentPercent,               // =D4*2%
                    advertising: sales * advertisingPercent, // =D4*3%
                    rnd: sales * rndPercent,                 // =E4*12% (pero aplicado a todos los meses configurablemente)
                    misc: miscExpenses[index] || 0           // Monto fijo por mes
                };
            });
        }
        
        // Calcular flujo de efectivo (réplica exacta de Excel)
        function calculateCashFlow() {
            const initialBalance = parseFloat(document.getElementById('initialBalance').value) || 0;
            const minBalance = parseFloat(document.getElementById('minBalance').value) || 0;
            
            budgetData.cashFlow = budgetData.months.map((month, index) => {
                // Total entradas (réplica de: =SUM(D6:D9))
                const collections = budgetData.collections[index];
                const totalIncome = collections.current + collections.first + collections.second;
                
                // Total salidas (réplica de: =SUM(D15:D22))
                const purchases = budgetData.purchases[index] || 0;
                const expenses = budgetData.expenses[index];
                const totalExpenses = purchases + expenses.salaries + expenses.rent + expenses.advertising + expenses.rnd + expenses.misc;
                
                // Flujo neto (réplica de: =D29-D30)
                const netFlow = totalIncome - totalExpenses;
                
                // Saldo inicial
                const initial = index === 0 ? initialBalance : budgetData.cashFlow[index - 1].final;
                
                // Saldo final (réplica de: =D31+D32)
                const final = initial + netFlow;
                
                // Diferencia con saldo mínimo (réplica de: =D33-D34)
                const difference = final - minBalance;
                
                return {
                    totalIncome,
                    totalExpenses,
                    netFlow,
                    initial,
                    final,
                    difference
                };
            });
        }
        
        // Actualizar valores en la tabla
        function updateTableValues() {
            // Actualizar cobranzas
            budgetData.collections.forEach((collection, index) => {
                document.querySelector(`.collection-cell[data-month="${index}"][data-type="current"]`).textContent = formatCurrency(collection.current);
                document.querySelector(`.collection-cell[data-month="${index}"][data-type="first"]`).textContent = formatCurrency(collection.first);
                document.querySelector(`.collection-cell[data-month="${index}"][data-type="second"]`).textContent = formatCurrency(collection.second);
            });
            
            // Actualizar total entradas
            budgetData.cashFlow.forEach((flow, index) => {
                document.querySelector(`.total-income-cell[data-month="${index}"]`).textContent = formatCurrency(flow.totalIncome);
            });
            
            // Actualizar compras
            budgetData.purchases.forEach((purchase, index) => {
                document.querySelector(`.purchase-cell[data-month="${index}"]`).textContent = formatCurrency(purchase);
            });
            
            // Actualizar gastos
            budgetData.expenses.forEach((expense, index) => {
                document.querySelector(`.expense-cell[data-month="${index}"][data-type="salaries"]`).textContent = formatCurrency(expense.salaries);
                document.querySelector(`.expense-cell[data-month="${index}"][data-type="rent"]`).textContent = formatCurrency(expense.rent);
                document.querySelector(`.expense-cell[data-month="${index}"][data-type="advertising"]`).textContent = formatCurrency(expense.advertising);
                document.querySelector(`.expense-cell[data-month="${index}"][data-type="rnd"]`).textContent = formatCurrency(expense.rnd);
            });
            
            // Actualizar total salidas
            budgetData.cashFlow.forEach((flow, index) => {
                document.querySelector(`.total-expense-cell[data-month="${index}"]`).textContent = formatCurrency(flow.totalExpenses);
            });
            
            // Actualizar flujo de efectivo
            budgetData.cashFlow.forEach((flow, index) => {
                document.querySelector(`.cash-flow-cell[data-month="${index}"]`).textContent = formatCurrency(flow.netFlow);
                document.querySelector(`.initial-balance-cell[data-month="${index}"]`).textContent = formatCurrency(flow.initial);
                document.querySelector(`.final-balance-cell[data-month="${index}"]`).textContent = formatCurrency(flow.final);
                
                const differenceCell = document.querySelector(`.balance-difference-cell[data-month="${index}"]`);
                differenceCell.textContent = formatCurrency(flow.difference);
                differenceCell.className = `balance-difference-cell ${flow.difference >= 0 ? 'cash-flow-positive' : 'cash-flow-negative'}`;
            });
        }
        
        // Formatear moneda
        function formatCurrency(value) {
            return new Intl.NumberFormat('es-MX', {
                style: 'currency',
                currency: 'MXN',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(value);
        }
        
        // Configurar event listeners
        function setupEventListeners() {
            // Calcular presupuesto
            document.getElementById('calculateBudget').addEventListener('click', calculateBudget);
            
            // Reiniciar presupuesto
            document.getElementById('resetBudget').addEventListener('click', function() {
                if (confirm('¿Estás seguro de que deseas reiniciar todo el presupuesto?')) {
                    initializeBudget();
                    showAlert('Presupuesto reiniciado correctamente', 'success');
                }
            });
            
            // Cambios en configuración
            document.getElementById('startMonth').addEventListener('change', function() {
                initializeBudget();
            });
            
            document.getElementById('monthsCount').addEventListener('change', function() {
                initializeBudget();
            });
            
            document.getElementById('initialBalance').addEventListener('change', function() {
                calculateBudget();
            });
            
            document.getElementById('minBalance').addEventListener('change', function() {
                calculateBudget();
            });
            
            // Cambios en porcentajes (recalcular automáticamente)
            document.querySelectorAll('.percentage-input').forEach(input => {
                input.addEventListener('change', calculateBudget);
                input.addEventListener('input', calculateBudget);
            });
            
            // Inputs de ventas y gastos varios
            document.addEventListener('input', function(e) {
                if (e.target.classList.contains('sales-input') || 
                    e.target.classList.contains('misc-expense-input') ||
                    e.target.classList.contains('custom-account-input')) {
                    calculateBudget();
                }
            });
            
            // Agregar cuenta personalizada
            document.getElementById('addCustomAccount').addEventListener('click', function() {
                const name = document.getElementById('customAccountName').value.trim();
                const type = document.getElementById('customAccountType').value;
                const amount = parseFloat(document.getElementById('customAccountAmount').value) || 0;
                
                if (!name) {
                    showAlert('Por favor ingresa un nombre para la cuenta', 'error');
                    return;
                }
                
                const newAccount = {
                    id: Date.now(),
                    name: name,
                    type: type,
                    amount: amount
                };
                
                budgetData.customAccounts.push(newAccount);
                addCustomAccountsToTable();
                calculateBudget();
                
                // Limpiar formulario
                document.getElementById('customAccountName').value = '';
                document.getElementById('customAccountAmount').value = '0';
                
                showAlert(`Cuenta "${name}" agregada correctamente`, 'success');
            });
            
            // Controles numéricos
            document.addEventListener('click', function(e) {
                if (e.target.closest('.number-control')) {
                    const control = e.target.closest('.number-control');
                    const target = control.dataset.target;
                    const month = control.dataset.month;
                    const account = control.dataset.account;
                    
                    let input;
                    
                    if (target === 'sales') {
                        input = document.querySelector(`.sales-input[data-month="${month}"]`);
                    } else if (target === 'misc') {
                        input = document.querySelector(`.misc-expense-input[data-month="${month}"]`);
                    } else if (target === 'custom') {
                        input = document.querySelector(`.custom-account-input[data-account="${account}"][data-month="${month}"]`);
                    } else {
                        input = document.getElementById(target);
                    }
                    
                    if (input) {
                        const currentValue = parseFloat(input.value) || 0;
                        const step = parseFloat(input.step) || (input.classList.contains('percentage-input') ? 0.1 : 1000);
                        const newValue = control.classList.contains('increase') ? 
                            currentValue + step : Math.max(0, currentValue - step);
                        
                        input.value = newValue;
                        
                        // Disparar evento change
                        const event = new Event('input', { bubbles: true });
                        input.dispatchEvent(event);
                    }
                }
            });
            
            // Configurar subida de archivos
            setupFileUpload();
        }
        
        // Configurar subida de archivos
        function setupFileUpload() {
            const excelFileInput = document.getElementById('excelFile');
            const excelFileName = document.getElementById('excelFileName');
            
            excelFileInput.addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    selectedFile = e.target.files[0];
                    excelFileName.textContent = selectedFile.name;
                    excelFileName.style.display = 'block';
                    showAlert(`Archivo "${selectedFile.name}" seleccionado`, 'info');
                }
            });
            
            // Drag and drop
            const uploadArea = document.getElementById('excelUploadArea');
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    const file = files[0];
                    if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                        selectedFile = file;
                        excelFileName.textContent = file.name;
                        excelFileName.style.display = 'block';
                        showAlert(`Archivo Excel "${file.name}" seleccionado`, 'info');
                    } else {
                        showAlert('Solo se permiten archivos Excel (.xlsx, .xls)', 'error');
                    }
                }
            });
            
            // Procesar importación
            document.getElementById('processImport').addEventListener('click', function() {
                if (!selectedFile) {
                    showAlert('Por favor selecciona un archivo Excel', 'error');
                    return;
                }
                
                // Simular procesamiento de importación
                showAlert('Procesando archivo Excel...', 'info');
                
                setTimeout(() => {
                    // Aquí iría la lógica real de importación desde Excel
                    // Por ahora, simulamos datos de ejemplo basados en el Excel proporcionado
                    const exampleData = {
                        sales: [425000, 500000, 600000, 625000, 650000, 700000],
                        miscExpenses: [15000, 20000, 25000, 30000, 35000, 40000]
                    };
                    
                    // Aplicar datos de ejemplo
                    const salesInputs = document.querySelectorAll('.sales-input');
                    salesInputs.forEach((input, index) => {
                        if (exampleData.sales[index]) {
                            input.value = exampleData.sales[index];
                        }
                    });
                    
                    const miscInputs = document.querySelectorAll('.misc-expense-input');
                    miscInputs.forEach((input, index) => {
                        if (exampleData.miscExpenses[index]) {
                            input.value = exampleData.miscExpenses[index];
                        }
                    });
                    
                    // Recalcular
                    calculateBudget();
                    
                    // Limpiar selección
                    selectedFile = null;
                    excelFileName.style.display = 'none';
                    excelFileInput.value = '';
                    
                    bootstrap.Modal.getInstance(document.getElementById('importModal')).hide();
                    showAlert('Datos importados correctamente desde Excel', 'success');
                }, 2000);
            });
            
            // Exportar a Excel
            document.getElementById('exportExcel').addEventListener('click', function() {
                showAlert('Preparando descarga de Excel...', 'info');
                // Aquí iría la lógica real de exportación a Excel
            });
            
            // Exportar a PDF
            document.getElementById('exportPDF').addEventListener('click', function() {
                showAlert('Preparando descarga de PDF...', 'info');
                // Aquí iría la lógica real de exportación a PDF
            });
        }
        
        // Función para mostrar alertas
        function showAlert(message, type) {
            // Crear elemento de alerta
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show`;
            alertDiv.style.cssText = `
                position: fixed;
                top: 100px;
                right: 20px;
                z-index: 9999;
                min-width: 300px;
                box-shadow: 0 10px 25px rgba(0,0,0,0.3);
                border-radius: 12px;
                border: none;
                background: ${type === 'success' ? 'linear-gradient(135deg, var(--success-color), var(--neon-cyan))' : 
                          type === 'error' ? 'linear-gradient(135deg, var(--danger-color), #f87171)' : 
                          type === 'warning' ? 'linear-gradient(135deg, var(--warning-color), #f59e0b)' :
                          'linear-gradient(135deg, var(--neon-blue), var(--neon-purple))'};
                color: white;
            `;
            alertDiv.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : type === 'warning' ? 'exclamation-circle' : 'info-circle'} me-2"></i>
                    <div>
                        <strong class="d-block">${type === 'success' ? 'Éxito' : type === 'error' ? 'Error' : type === 'warning' ? 'Advertencia' : 'Información'}</strong>
                        ${message}
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(alertDiv);
            
            // Auto-remover después de 4 segundos
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 4000);
        }
        
        // Inicializar
        initializeBudget();
    });
</script>
{% endblock %}